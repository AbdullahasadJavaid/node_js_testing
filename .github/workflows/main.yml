name: Node.js CI/CD to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:
    
jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout code (for CI only, not EC2)
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3Ô∏è‚É£ Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # 4Ô∏è‚É£ Deploy to EC2
      - name: Deploy to EC2
        run: |
          echo "==== Starting deployment ===="

          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            set -x

            APP_DIR="${{ secrets.APP_DIR }}"
            REPO_URL="https://github.com/YOUR_USERNAME/YOUR_REPO.git"

            echo "---- Connected to EC2 ----"
            whoami
            hostname

            echo "---- Moving to app directory ----"
            mkdir -p "$APP_DIR"
            cd "$APP_DIR"

            echo "---- Checking Git repository ----"
            if [ ! -d ".git" ]; then
              echo "üì¶ Repo not found. Cloning..."
              git clone "$REPO_URL" .
            else
              echo "üì¶ Repo found. Updating..."
              git reset --hard
              git clean -fd
              git pull origin main
            fi

            echo "---- Installing dependencies ----"
            npm install --verbose

            echo "---- Restarting app ----"
            pm2 restart node-backend || pm2 start index.js --name node-backend

            pm2 save

            echo "‚úÖ Deployment completed successfully"
          ENDSSH

          echo "==== Deployment finished ===="
